<!-- CHANGEMENT: Conteneur avec hauteur fixe et scroll interne -->
<div class="form-container">
    <div class="form-card">
        <!-- En-tÃªte fixe -->
        <div class="card-header">
            <h2>{{ isEditMode ? 'Modifier' : 'Nouvelle' }} Heure de Pointage</h2>
        </div>

        <!-- Corps du formulaire avec scroll interne -->
        <div class="card-content">
            <form [formGroup]="pointingHourForm" (ngSubmit)="onSubmit()">

                <!-- Heure de dÃ©but -->
                <div class="form-group">
                    <label for="startTime">Heure de dÃ©but <span class="required">*</span></label>
                    <input
                            type="datetime-local"
                            id="startTime"
                            formControlName="startTime"
                            class="form-control"
                            [ngClass]="{'invalid': isFieldInvalid('startTime')}"
                            [min]="minDateTime"
                    >
                    <div class="error-message" *ngIf="isFieldInvalid('startTime')">
                        <span *ngIf="pointingHourForm.get('startTime')?.errors?.['required']">
                            L'heure de dÃ©but est obligatoire
                        </span>
                        <span *ngIf="pointingHourForm.get('startTime')?.errors?.['futureDate']">
                            L'heure de dÃ©but doit Ãªtre dans le futur
                        </span>
                    </div>
                </div>

                <!-- Marge -->
                <div class="form-group">
                    <label for="marge">Marge (minutes) <span class="required">*</span></label>
                    <input
                            type="number"
                            id="marge"
                            formControlName="marge"
                            placeholder="Saisir la marge en minutes"
                            class="form-control"
                            [ngClass]="{'invalid': isFieldInvalid('marge')}"
                            min="0"
                    >
                    <div class="error-message" *ngIf="isFieldInvalid('marge')">
                        <span *ngIf="pointingHourForm.get('marge')?.errors?.['required']">
                          La marge est obligatoire
                        </span>
                        <span *ngIf="pointingHourForm.get('marge')?.errors?.['min']">
                            La marge doit Ãªtre positive ou nulle
                        </span>
                    </div>
                </div>

                <!-- NOUVEAU: Heure de fin -->
                <div class="form-group">
                    <label for="endTime">Heure de fin <span class="required">*</span></label>
                    <input
                            type="datetime-local"
                            id="endTime"
                            formControlName="endTime"
                            class="form-control"
                            [ngClass]="{'invalid': isFieldInvalid('endTime')}"
                    >
                    <div class="error-message" *ngIf="isFieldInvalid('endTime')">
                        <span *ngIf="pointingHourForm.get('endTime')?.errors?.['required']">
                            L'heure de fin est obligatoire
                        </span>
                        <span *ngIf="pointingHourForm.get('endTime')?.errors?.['endTimeBeforeStart']">
                            L'heure de fin doit Ãªtre postÃ©rieure Ã  l'heure de dÃ©but
                        </span>
                    </div>
                    <small class="form-hint">
                        ðŸ’¡ L'heure de fin se calcule automatiquement avec la marge, ou vous pouvez la modifier manuellement
                    </small>
                </div>

                <!-- CHANGEMENT: Section de sÃ©lection avec style amÃ©liorÃ© -->
                <div class="selection-section">
                    <p class="selection-note">
                        <i class="icon-info"></i>
                        SÃ©lectionnez soit une classe/service, soit un utilisateur (exclusif).
                    </p>

                    <!-- Classe/Service -->
                    <div class="form-group">
                        <label for="classServiceId">Classe / Service</label>
                        <div class="select-wrapper">
                            <select
                                    id="classServiceId"
                                    formControlName="classServiceId"
                                    class="form-control select-scrollable"
                                    [ngClass]="{'invalid': isFieldInvalid('classServiceId')}"
                            >
                                <option value="">-- SÃ©lectionner une classe/service --</option>
                                <option *ngFor="let classService of availableClassServiceIds" [value]="classService.id">
                                    {{ classService.nom }}
                                </option>
                            </select>
                        </div>
                    </div>

                    <!-- Utilisateur -->
                    <div class="form-group">
                        <label for="userId">Utilisateur</label>
                        <div class="select-wrapper">
                            <select
                                    id="userId"
                                    formControlName="userId"
                                    class="form-control select-scrollable"
                                    [ngClass]="{'invalid': isFieldInvalid('userId')}"
                            >
                                <option value="">-- SÃ©lectionner un utilisateur --</option>
                                <option *ngFor="let user of availableUserIds" [value]="user.id">
                                    {{ user.firstName }} {{ user.lastName }}
                                </option>
                            </select>
                        </div>
                    </div>

                    <!-- CHANGEMENT: Validateur -->
                    <div class="form-group" [ngClass]="{'disabled': !isValidatorEnabled()}">
                        <label for="validatorId">
                            Validateur <span class="required" *ngIf="isValidatorEnabled()">*</span>
                            <span class="optional-text" *ngIf="!isValidatorEnabled()">(SÃ©lectionnez d'abord une classe ou un utilisateur)</span>
                        </label>
                        <div class="select-wrapper">
                            <select
                                    id="validatorId"
                                    formControlName="validatorId"
                                    *ngIf="!updatingForm"
                                    class="form-control select-scrollable"
                                    [disabled]="!isValidatorEnabled()"
                                    [ngClass]="{'invalid': isFieldInvalid('validatorId')}"
                            >
                                <option value="">-- SÃ©lectionner un validateur --</option>
                                <option *ngFor="let validator of availableValidators; trackBy: trackByUserId" [value]="validator.id">
                                    {{ validator.firstName }} {{ validator.lastName }}
                                </option>
                            </select>
                        </div>
                        <div class="error-message" *ngIf="isFieldInvalid('validatorId')">
              <span *ngIf="pointingHourForm.get('validatorId')?.errors?.['required']">
                Le validateur est obligatoire
              </span>
                        </div>
                    </div>

                    <!-- CHANGEMENT: Message d'erreur global pour la sÃ©lection -->
                    <div class="global-error" *ngIf="!pointingHourForm.get('classServiceId')?.value && !pointingHourForm.get('userId')?.value && (pointingHourForm.get('classServiceId')?.touched || pointingHourForm.get('userId')?.touched)">
                        Vous devez sÃ©lectionner soit une classe/service, soit un utilisateur.
                    </div>
                </div>
            </form>
        </div>

        <!-- CHANGEMENT: Barre de boutons fixe en bas -->
        <div class="form-actions">
            <button type="button" class="btn btn-secondary" (click)="onCancel()">
                Annuler
            </button>
            <button
                    type="submit"
                    class="btn btn-primary"
                    [disabled]="!isFormValid()"
                    (click)="onSubmit()"
            >
                {{ isEditMode ? 'Mettre Ã  jour' : 'CrÃ©er' }}
            </button>
        </div>
    </div>
</div>