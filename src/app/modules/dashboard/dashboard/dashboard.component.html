<app-layout>
    <div class="main-content">
        <app-navbar [pageTitle]="establishmentName"></app-navbar>
    </div>

    <div class="dashboard-content" *ngIf="currentEstablishment && !isLoading">
        <div class="main-section">
            <!-- Statistiques en haut -->
            <div class="statistics-section">
                <app-statistics-cards
                        [currentUsersCount]="userMetrics?.currentUsers || 0"
                        [adminsCount]="userMetrics?.adminsCount || 0"
                        [classesCount]="userMetrics?.maxUsers || 0"
                        [globalPresencePercentage]="dailyStats?.presenceRate || 0"
                        [isSuperAdmin]="false">
                </app-statistics-cards>
            </div>

            <!-- Graphique de performance -->
            <div class="performance-section">
                <app-school-performance-chart
                        [yearlyPresenceStats]="yearlyStats"
                        [currentYear]="currentYear"
                        [previousYear]="previousYear">
                </app-school-performance-chart>
            </div>

            <!-- Section deux colonnes -->
            <div class="two-columns-section">
                <div class="column calendar-column">
                    <app-organization-calendar></app-organization-calendar>
                </div>
                <div class="column presence-column">
                    <app-organization-presence-chart
                            [establishmentId]="establishmentId">
                    </app-organization-presence-chart>
                </div>
            </div>

            <!-- Activités récentes -->
            <div class="activity-section">
                <app-recent-administration-activity
                        [establishmentId]="establishmentId"
                        [isSuperAdmin]="false">
                </app-recent-administration-activity>
            </div>
        </div>

        <div class="sidebar-section">
            <!-- Étudiants récents -->
            <div class="recent-students-block">
                <app-recent-students
                        [establishmentId]="establishmentId"
                        [isSuperAdmin]="false">
                </app-recent-students>
            </div>

            <!-- Messages -->
            <div class="messages-block">
                <app-dashboard-messages
                        [establishmentId]="establishmentId">
                </app-dashboard-messages>
            </div>
        </div>
    </div>

    <!-- État de chargement -->
    <div class="loading-container" *ngIf="isLoading">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p class="loading-text">Chargement des données en cours...</p>
        </div>
    </div>

    <!-- Avertissement pas d'établissement -->
    <div class="no-establishment-container" *ngIf="!isLoading && !currentEstablishment">
        <div class="no-establishment-card">
            <div class="warning-icon">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 9V13M12 17.0195V17M4.5 21H19.5C20.5 21 21.2 20.1 20.9 19.2L13.4 4.2C13.1 3.3 12.9 3.3 12.6 4.2L5.1 19.2C4.8 20.1 5.5 21 4.5 21Z" stroke="#FF6B35" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </div>

            <h2 class="warning-title">Établissement non trouvé</h2>
            <p class="warning-description">
                Nous n'avons pas réussi à identifier votre établissement.
                Certaines fonctionnalités seront limitées.
            </p>

            <div class="features-grid">
                <div class="available-features">
                    <h3>✅ Fonctionnalités disponibles</h3>
                    <ul>
                        <li>Profil utilisateur</li>
                        <li>Paramètres du compte</li>
                        <li>Messagerie (vers les administrateurs)</li>
                    </ul>
                </div>

                <div class="unavailable-features">
                    <h3>❌ Fonctionnalités non disponibles</h3>
                    <ul>
                        <li>Statistiques de présence</li>
                        <li>Performance de l'établissement</li>
                        <li>Gestion des classes / services</li>
                        <li>Gestion des zones de pointage</li>
                        <li>Gestion des heures de pointage</li>
                        <li>Gestion des administrateurs</li>
                        <li>Gestion des utilisateurs</li>
                        <li>Gestion du babillard</li>
                        <li>Calendrier organisationnel</li>
                    </ul>
                </div>
            </div>

            <h1 class="solution-title">Solution :
                <strong>lier votre compte à une organisation / établissement</strong>
            </h1>
            <p class="contact-message">
                Veuillez contacter l'administration si cela persiste.
            </p>

            <button class="retry-button" (click)="retryLoading()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M1 4V10H7M23 20V14H17M20.49 9A9 9 0 0 0 5.64 5.64L1 10M23 14L18.36 18.36A9 9 0 0 1 3.51 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Réessayer
            </button>
        </div>
    </div>
</app-layout>