<app-layout>
    <div class="user-form-container">
        <app-navbar pageTitle="{{ isEditMode ? 'Modifier l\'utilisateur' : 'Cr√©er un utilisateur' }}"></app-navbar>

        <div class="form-card">
            <form [formGroup]="userForm" (ngSubmit)="onSubmit()">
                <!-- Section Informations Personnelles -->
                <div class="form-section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <span class="section-icon">üë§</span>
                            Informations Personnelles
                        </h2>
                    </div>

                    <div class="form-content">
                        <!-- Photo et informations principales -->
                        <div class="main-info-grid">
                            <!-- Photo Upload -->
                            <div class="photo-section">
                                <div class="form-group">
                                    <label class="form-label">Photo de profil</label>
                                    <div class="photo-upload-container" (click)="fileInput.click()">
                                        <input
                                                type="file"
                                                #fileInput
                                                (change)="onFileSelected($event)"
                                                accept="image/*"
                                                hidden
                                        >

                                        <div class="photo-preview" *ngIf="previewImageUrl; else placeholderPhoto">
                                            <img [src]="previewImageUrl" alt="Photo de profil">
                                            <div class="photo-overlay">
                                                <span>Modifier</span>
                                            </div>
                                        </div>

                                        <ng-template #placeholderPhoto>
                                            <div class="photo-placeholder">
                                                <div class="upload-icon">üì∑</div>
                                                <p>Ajouter une photo</p>
                                                <small>Format accept√© : JPG, PNG</small>
                                            </div>
                                        </ng-template>
                                    </div>
                                </div>
                            </div>

                            <!-- Informations de base -->
                            <div class="basic-info-grid">
                                <!-- Nom et pr√©nom -->
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label required">Pr√©nom</label>
                                        <input
                                                type="text"
                                                formControlName="firstName"
                                                placeholder="Entrez le pr√©nom"
                                                [class.error]="userForm.get('firstName')?.invalid && userForm.get('firstName')?.touched"
                                        >
                                        <div class="error-message" *ngIf="userForm.get('firstName')?.invalid && userForm.get('firstName')?.touched">
                                            Le pr√©nom est requis
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label required">Nom</label>
                                        <input
                                                type="text"
                                                formControlName="lastName"
                                                placeholder="Entrez le nom"
                                                [class.error]="userForm.get('lastName')?.invalid && userForm.get('lastName')?.touched"
                                        >
                                        <div class="error-message" *ngIf="userForm.get('lastName')?.invalid && userForm.get('lastName')?.touched">
                                            Le nom est requis
                                        </div>
                                    </div>
                                </div>

                                <!-- Date et lieu de naissance -->
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label required">Date de naissance</label>
                                        <input
                                                type="date"
                                                formControlName="dateOfBirth"
                                                [class.error]="userForm.get('dateOfBirth')?.invalid && userForm.get('dateOfBirth')?.touched"
                                        >
                                        <div class="error-message" *ngIf="userForm.get('dateOfBirth')?.invalid && userForm.get('dateOfBirth')?.touched">
                                            La date de naissance est requise
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label required">Lieu de naissance</label>
                                        <input
                                                type="text"
                                                formControlName="placeOfBirth"
                                                placeholder="Entrez le lieu de naissance"
                                                [class.error]="userForm.get('placeOfBirth')?.invalid && userForm.get('placeOfBirth')?.touched"
                                        >
                                        <div class="error-message" *ngIf="userForm.get('placeOfBirth')?.invalid && userForm.get('placeOfBirth')?.touched">
                                            Le lieu de naissance est requis
                                        </div>
                                    </div>
                                </div>

                                <!-- Contact -->
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label required">Email</label>
                                        <input
                                                type="email"
                                                formControlName="email"
                                                placeholder="exemple@email.com"
                                                [class.error]="userForm.get('email')?.invalid && userForm.get('email')?.touched"
                                        >
                                        <div class="error-message" *ngIf="userForm.get('email')?.invalid && userForm.get('email')?.touched">
                                            <span *ngIf="userForm.get('email')?.errors?.['required']">L'email est requis</span>
                                            <span *ngIf="userForm.get('email')?.errors?.['email']">Format d'email invalide</span>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label required">T√©l√©phone</label>
                                        <input
                                                type="tel"
                                                formControlName="phoneNumber"
                                                placeholder="+237 6 99 99 99 99"
                                                [class.error]="userForm.get('phoneNumber')?.invalid && userForm.get('phoneNumber')?.touched"
                                        >
                                        <div class="error-message" *ngIf="userForm.get('phoneNumber')?.invalid && userForm.get('phoneNumber')?.touched">
                                            Le num√©ro de t√©l√©phone est requis
                                        </div>
                                    </div>
                                </div>

                                <!-- R√¥le et service/√©tablissement -->
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label required">R√¥le</label>
                                        <div class="select-wrapper">
                                            <select
                                                    formControlName="role"
                                                    [class.error]="userForm.get('role')?.invalid && userForm.get('role')?.touched"
                                            >
                                                <option value="" disabled>S√©lectionner un r√¥le</option>
                                                <option *ngFor="let role of filteredRoles" [value]="role">{{ role }}</option>
                                            </select>
                                        </div>
                                        <div class="error-message" *ngIf="userForm.get('role')?.invalid && userForm.get('role')?.touched">
                                            Le r√¥le est requis
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">{{ fieldLabel }}</label>
                                        <div class="select-wrapper">
                                            <select formControlName="classServiceId">
                                                <option value="" disabled>S√©lectionner {{ fieldLabel.toLowerCase() }}</option>
                                                <option *ngFor="let option of options" [value]="option.id">{{ option.name }}</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <!-- Adresse (largeur compl√®te) -->
                                <div class="form-group full-width">
                                    <label class="form-label">Adresse</label>
                                    <textarea
                                            formControlName="address"
                                            placeholder="Entrez l'adresse compl√®te"
                                            rows="3"
                                            [class.error]="userForm.get('address')?.invalid && userForm.get('address')?.touched"
                                    ></textarea>
                                    <div class="char-counter">
                                        {{ (userForm.get('address')?.value || '').length }}/1000
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Section Permissions -->
                        <div class="permissions-container" *ngIf="showPermissions">
                            <div class="permissions-header">
                                <h3 class="permissions-title">
                                    <span class="permission-icon">üîê</span>
                                    Permissions
                                </h3>
                            </div>

                            <div class="permissions-grid" formGroupName="permissions" *ngIf="userForm.get('permissions')">
                                <div class="permission-card" *ngFor="let permission of permissionsList">
                                    <label class="permission-label">
                                        <input
                                                type="checkbox"
                                                [formControlName]="permission"
                                                class="permission-checkbox"
                                        >
                                        <span class="permission-text">{{ permission }}</span>
                                        <span class="checkmark"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section Identifiants de compte -->
                <div class="form-section" *ngIf="!isEditMode">
                    <div class="section-header">
                        <h2 class="section-title">
                            <span class="section-icon">üîë</span>
                            Identifiants de compte
                        </h2>
                    </div>

                    <div class="form-content">
                        <div class="credentials-grid">
                            <div class="form-group">
                                <label class="form-label required">Mot de passe</label>
                                <div class="password-input-container">
                                    <input
                                            [type]="showPassword ? 'text' : 'password'"
                                            formControlName="password"
                                            placeholder="Entrez le mot de passe"
                                            [class.error]="userForm.get('password')?.invalid && userForm.get('password')?.touched"
                                    >
                                    <button
                                            type="button"
                                            class="password-toggle"
                                            (click)="togglePasswordVisibility('password')"
                                    >
                                        <span *ngIf="showPassword">üëÅÔ∏è</span>
                                        <span *ngIf="!showPassword">üëÅÔ∏è‚Äçüó®Ô∏è</span>
                                    </button>
                                </div>
                                <div class="error-message" *ngIf="userForm.get('password')?.errors?.['passwordRequirements']">
                                    {{ userForm.get('password')?.errors?.['passwordRequirements'] }}
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label required">Confirmer le mot de passe</label>
                                <div class="password-input-container">
                                    <input
                                            [type]="showConfirmPassword ? 'text' : 'password'"
                                            formControlName="confirmPassword"
                                            placeholder="Confirmez le mot de passe"
                                            [class.error]="(userForm.hasError('passwordMismatch') || userForm.get('confirmPassword')?.invalid) && userForm.get('confirmPassword')?.touched"
                                    >
                                    <button
                                            type="button"
                                            class="password-toggle"
                                            (click)="togglePasswordVisibility('confirmPassword')"
                                    >
                                        <span *ngIf="showConfirmPassword">üëÅÔ∏è</span>
                                        <span *ngIf="!showConfirmPassword">üëÅÔ∏è‚Äçüó®Ô∏è</span>
                                    </button>
                                </div>
                                <div class="error-message" *ngIf="userForm.hasError('passwordMismatch') && userForm.get('confirmPassword')?.touched">
                                    Les mots de passe ne correspondent pas
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Actions du formulaire -->
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" (click)="onCancel()">
                        <span class="btn-icon">‚Ü∂</span>
                        Annuler
                    </button>
                    <button type="submit" class="btn btn-primary" [disabled]="userForm.invalid">
                        <span class="btn-icon">‚úì</span>
                        {{ isEditMode ? 'Mettre √† jour' : 'Cr√©er' }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</app-layout>